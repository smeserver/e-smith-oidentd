Index: e-smith-oidentd/createlinks
diff -u e-smith-oidentd/createlinks:1.1.1.1 e-smith-oidentd/createlinks:1.3
--- e-smith-oidentd/createlinks:1.1.1.1	Wed Aug 28 15:18:29 2002
+++ e-smith-oidentd/createlinks	Mon Sep 22 00:52:11 2003
@@ -1,28 +1,14 @@
 #!/usr/bin/perl -w
 
+use esmith::Build::CreateLinks qw(:all);
 
-sub safe_symlink {
-    my ($from, $to) = @_;
-    use File::Basename;
-    use File::Path;
-    mkpath(dirname($to));
-    unlink($to);
-    symlink($from, $to) or die "Can't create symlink from $from to $to: $!";
-}
-
-sub event_link
-{
-    my ($action, $event, $level) = @_;
-
-    safe_symlink("../actions/${action}",
-        "root/etc/e-smith/events/${event}/S${level}${action}");
-}
+safe_symlink("/etc/rc.d/init.d/daemontools",
+    "root/etc/rc.d/init.d/supervise/oidentd");
 
 #--------------------------------------------------
 # actions for console-save event
 #--------------------------------------------------
-foreach my $event (qw(console-save bootstrap-console-save
-	post-install post-upgrade))
+foreach my $event (qw(console-save bootstrap-console-save))
 {
     event_link("conf-oidentd", $event, "50");
 }
Index: e-smith-oidentd/e-smith-oidentd.spec
diff -u /dev/null e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/access:1.1
--- /dev/null	Mon Sep 22 00:55:08 2003
+++ e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/access	Mon Sep 22 00:38:58 2003
@@ -0,0 +1 @@
+public
Index: e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/status
diff -u /dev/null e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/status:1.1
--- /dev/null	Mon Sep 22 00:55:08 2003
+++ e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/status	Mon Sep 22 00:38:58 2003
@@ -0,0 +1 @@
+enabled
Index: e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/type
diff -u /dev/null e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/type:1.1
--- /dev/null	Mon Sep 22 00:55:08 2003
+++ e-smith-oidentd/root/etc/e-smith/db/configuration/defaults/oidentd/type	Mon Sep 22 00:38:58 2003
@@ -0,0 +1 @@
+service
Index: e-smith-oidentd/root/etc/e-smith/db/configuration/migrate/20Auth
diff -u /dev/null e-smith-oidentd/root/etc/e-smith/db/configuration/migrate/20Auth:1.1
--- /dev/null	Mon Sep 22 00:55:08 2003
+++ e-smith-oidentd/root/etc/e-smith/db/configuration/migrate/20Auth	Mon Sep 22 00:38:58 2003
@@ -0,0 +1,10 @@
+{
+    my $auth = $DB->get('auth');
+    my $oidentd = $DB->get('oidentd');
+    if ($auth)
+    {
+	$oidentd ||= new_record('oidentd, {type => 'service'});
+	$oidentd->merge_props($auth->props);
+	$auth->delete;
+    }
+}
Index: e-smith-oidentd/root/etc/e-smith/events/actions/conf-oidentd
diff -u e-smith-oidentd/root/etc/e-smith/events/actions/conf-oidentd:1.1.1.1 e-smith-oidentd/root/etc/e-smith/events/actions/conf-oidentd:1.2
--- e-smith-oidentd/root/etc/e-smith/events/actions/conf-oidentd:1.1.1.1	Wed Aug 28 15:18:29 2002
+++ e-smith-oidentd/root/etc/e-smith/events/actions/conf-oidentd	Mon Sep 22 00:38:58 2003
@@ -25,49 +25,13 @@
 
 use strict;
 use Errno;
+use esmith::templates;
 
-my $event = shift || die "Must specify event name\n";
-
-if ($event eq "post-install" || $event eq "post-upgrade")
-{
-    use esmith::ConfigDB;
-
-    #--------------------------------------------------------------
-    # First, check to see if the "auth" service has been enabled in the
-    # services database. If so, remember the properties and delete
-    # the "auth" setting.
-    # Now create a new "oidentd" service entry if one does not exist.
-    #--------------------------------------------------------------
-
-    my %props = (
-	type => "service",
-	status => "enabled",
-	access => "public",
-	);
-
-    my $conf = esmith::ConfigDB->open() or die "Unable to open config DB";
-    my $rec = $conf->get('auth');
-    if ($rec)
-    {
-	%props = $rec->props;
-	$rec->delete;
-	}
-    $rec = $conf->get('oidentd');
-    unless ($rec)
-    {
-	$rec = $conf->new_record('oidentd', \%props);
-    }
-}
-else
-{
-    use esmith::templates;
-
-    #----------------------------------------------------------------------
-    # Fake ident replies for servers that think the replies are useful :-)
-    #----------------------------------------------------------------------
-    esmith::templates::processTemplate ({
-	TEMPLATE_PATH => "/etc/oidentd_masq.conf",
-	});
-}
+#----------------------------------------------------------------------
+# Fake ident replies for servers that think the replies are useful :-)
+#----------------------------------------------------------------------
+esmith::templates::processTemplate ({
+    TEMPLATE_PATH => "/etc/oidentd_masq.conf",
+    });
 
 exit (0);
Index: e-smith-oidentd/root/var/service/oidentd/run
diff -u /dev/null e-smith-oidentd/root/var/service/oidentd/run:1.1
--- /dev/null	Mon Sep 22 00:55:08 2003
+++ e-smith-oidentd/root/var/service/oidentd/run	Mon Sep 22 00:38:58 2003
@@ -0,0 +1,3 @@
+#! /bin/sh
+exec 2>&1
+exec oidentd -i -S -t 10 -u daemon -g daemon
Index: e-smith-oidentd/root/var/service/oidentd/log/run
diff -u /dev/null e-smith-oidentd/root/var/service/oidentd/log/run:1.1
--- /dev/null	Mon Sep 22 00:55:08 2003
+++ e-smith-oidentd/root/var/service/oidentd/log/run	Mon Sep 22 00:38:58 2003
@@ -0,0 +1,2 @@
+#!/bin/sh
+exec setuidgid smelog multilog t /var/log/oidentd
